<!Doctype html>
<html>

	<head>
	<script type="text/javascript" >
		if (!("geolocation" in navigator)) {
			/* geolocation IS NOT available */
			throw new Error("cannot get current location");
		}

		/*
			APIKEYS HERE
		*/
		var services = {
			"google": {
				getQuery: function(query, coords){
					//https://developers.google.com/places/webservice/search#TextSearchRequests
					return "https://maps.googleapis.com/maps/api/place/textsearch/json"+
						"?latitude="+coords.latitude+"&longitude="+coords.longitude+"&query="+query
				},
				getSearchResult: function(obj){
					obj = obj.results[Math.floor(obj.results.length*Math.random())];
					return {
						name: obj.name,
						image: obj.photo[0],
						location:obj.location
					}
				}
			},
			"yelp":{
				getQuery: function(query,coords){
					//https://www.yelp.com/developers/documentation/v2/search_api
					return "http://api.yelp.com/v2/search" +
					"?latitude="+coords.latitude+"&longitude="+coords.longitude+"&term="+query
				},
				getSearchResult: function(obj){
					obj = obj.businesses[Math.floor(obj.businesses.length*Math.random())];
					return {
						name:obj.name,
						image: obj.image_url,
						location:obj.location
					}
				}
			},
			"meetup": {
				getQuery: function(query,coords){
					//https://secure.meetup.com/meetup_api/console/?path=/2/cities
					return "https://api.meetup.com/find/groups"+
					"?lat="+coords.latitude+"&lon="+coords.longitude+"&text="+query
				},
				getSearchResult: function(obj){
					var key = Object.keys(obj);
					obj = obj[key[Math.floor(key.length*Math.random())]];
					return {
						name:obj.name,
						location:{
							latitude:obj.lat,
							longitude:obj.lon
						}
					};
				}
			}
		};

		function Plan(list){
			this.list = list;
			this.query = document.getElementById("query").value;
			var self = this;
			navigator.geolocation.getCurrentPosition(function(position) {
				self.coords = position.coords;
				for(var i=0;i<10;i++) self.getRandom();
			});
		}
		Plan.prototype.getRandom = function(){
			var key = Object.keys(services);
			key = key[Math.floor(key.length*Math.random())];
			var self = this;
			var req = new XMLHttpRequest();
			req.addEventListener("load",function(res){
				self.renderItem(getSearchResult(JSON.parse(res.responseText)),this.coords);
			});
			req.open("get", services[key].getQuery(this.query,this.location), true);
			oReq.send();
		};
		Plan.prototype.renderItem = function(obj){
			var li = document.createElement("li");
			li.innerHTML = obj.name;
			this.list.appenChild(li);
		};

		window.addEventListener("load",function(){
			document.getElementById("plan-maker").addEventListener("click",function(){
				var plan = document.getElementById("plan");
				plan.innerHTML = "";
				new Plan(plan);
			});
		});
	</script>
	</head>
	<body>
		<input type="text" id="query" />
		<button id="plan-maker">Make Plan</button>
		<ul id="plan"></ul>
	</body>
</html>
